!function t(e,i,n){function a(s,o){if(!i[s]){if(!e[s]){var c="function"==typeof require&&require;if(!o&&c)return c(s,!0);if(r)return r(s,!0);throw new Error("Cannot find module '"+s+"'")}var l=i[s]={exports:{}};e[s][0].call(l.exports,function(t){var i=e[s][1][t];return a(i?i:t)},l,l.exports,t,e,i,n)}return i[s].exports}for(var r="function"==typeof require&&require,s=0;s<n.length;s++)a(n[s]);return a}({1:[function(t){function e(t){return"#"==t.charAt(0)&&(t=t.slice(1)),3==t.length&&(t=t.charAt(0)+t.charAt(0)+t.charAt(1)+t.charAt(1)+t.charAt(2)+t.charAt(2)),[Number("0x"+t.slice(0,2)),Number("0x"+t.slice(2,4)),Number("0x"+t.slice(4))]}var i=t("./krion/krion"),n={"Дерево":{color:"#b47e4d",enName:"wood"},"Кирпич":{color:"#ff6464",enName:"brick"},"Панель":{color:"#008965",enName:"panel"},"Бетон":{color:"#a04089",enName:"concrete"},"Металл":{color:"#0088ff",enName:"metal"}},a={radius:5e-4,maxOpacity:.7,scaleRadius:!0,blur:1,useLocalExtrema:!0,latField:"lat",lngField:"lng",valueField:"count"},r=i.createClass(i.Emitter,{__name:"MaterialsApp",_cities:null,_selectedCityTransliteratedName:null,_materialDataLoadingEmitter:null,_cityListIsShown:!1,_map:null,_heatmapLayers:null,element:null,_bMap:null,_tfCity:null,_bMaterials:null,_bcMaterialOptions:null,_bCityList:null,_bcCityListLinks:null,_btnReadMore:null,_init:function(){i.bindListeners(this),this.element=document.body,DG.then(function(){this._findBlocks(),this._map=DG.map(this._bMap,{center:[54.98,82.89],zoom:13}),this._loadScripts(function(){this._createHeatmapLayers(),i.ajax.jsonp("data/cities/index.jsonp",function(t){this._cities=t.reduce(function(t,e){return t[e.transliteratedName]=e,t},{}),this._updateTFCityAndBCityList("Novosybyrsk"),this._updateBMaterials(),this._bindListeners(),this._loadMaterialData(this._selectedCityTransliteratedName,this._updateHeatmapLayers)}.bind(this),{callbackName:"_setData"})}.bind(this))}.bind(this))},_findBlocks:function(){var t=this.element;this._bMap=t.querySelector("[data-name=bMap]"),this._tfCity=t.querySelector("[data-name=tfCity]"),this._bMaterials=t.querySelector("[data-name=bMaterials]"),this._bCityList=t.querySelector("[data-name=bCityList]"),this._btnReadMore=t.querySelector("[data-name=btnReadMore]")},_loadScripts:function(t){i.dom.addScript("node_modules/heatmap.js/build/heatmap.js",function(){i.dom.addScript("node_modules/heatmap.js/plugins/leaflet-heatmap.js",function(){t.call(this)})})},_createHeatmapLayers:function(){this._heatmapLayers=Object.keys(n).reduce(function(t,r){var s=n[r].color;return t[r]=new HeatmapOverlay(i.object.assign(Object.create(a),{gradient:{0:i.tmpl.format("rgba(%1, %2, %3, 0)",e(s)),1:s}})),t},{})},_updateTFCityAndBCityList:function(t){var e=this._bCityList,n=this._bcCityListLinks={};Object.keys(this._cities).forEach(function(t){var a=this._cities[t],r=i.dom.createElementFromHTML('<a data-transliterated-name="%1" href="#%1">%2</a>',t,a.name),s=i.dom.createElement("li",null,[r]);n[t]=r,e.appendChild(s)},this),t&&this._setCityInControlPanel(t)},_setCityInControlPanel:function(t){var e=this._cities[t];this._selectedCityTransliteratedName&&(this._tfCity.classList.remove("_city-"+this._selectedCityTransliteratedName),this._bcCityListLinks[this._selectedCityTransliteratedName].classList.remove("_selected")),this._selectedCityTransliteratedName=t,this._tfCity.classList.add("_city-"+t),this._tfCity.lastElementChild.innerHTML=e.name,this._bcCityListLinks[t].classList.add("_selected")},_updateBMaterials:function(){var t=this._bMaterials;this._bcMaterialOptions=Object.keys(n).reduce(function(e,a){var r=i.dom.createElementFromHTML('<label class="chb _material-%1"><input type="checkbox" checked="checked" /><span></span>%2</label>',n[a].enName,a);return e[a]=r.firstChild,t.appendChild(r),e},{})},_bindListeners:function(){this.listenTo(this._tfCity,"click",this._onTFCityClick),this.listenTo(this._bCityList,"click",this._onBCityListClick),Object.keys(this._bcMaterialOptions).forEach(function(t){this.listenTo(this._bcMaterialOptions[t],"change",this._onBCMaterialOptionsChange)},this)},_onTFCityClick:function(t){t.preventDefault(),this.toogleCityList()},_onBCityListClick:function(t){setTimeout(function(){for(var e,i=t.target;i!=this._bCityList;)"A"==i.tagName&&(e=i),i=i.parentNode;if(e){var n=e.dataset.transliteratedName;this._setCityInControlPanel(n),void 0===this._cities[n].materialData?this._loadMaterialData(n,this._updateHeatmapLayers):this._updateHeatmapLayers(),this.hideCityList()}}.bind(this),1)},_onBCMaterialOptionsChange:function(){setTimeout(function(){this._updateHeatmapLayers()}.bind(this),1)},_loadMaterialData:function(t,e){var n=this._cities[t];if(n.materialData)return void e.call(this);var a=this._materialDataLoadingEmitter||(this._materialDataLoadingEmitter=new i.Emitter);a.once("loaded:"+t,e,this),n.loadingMaterialData||(n.loadingMaterialData=!0,i.ajax.jsonp("data/cities/materials/"+t+".jsonp",function(e){n.loadingMaterialData=!1,n.materialData=e,a.emit("loaded:"+t)},{callbackName:"_setData"}))},_updateHeatmapLayers:function(){var t=this._selectedCityTransliteratedName;if(this._cities.hasOwnProperty(t)){var e=this._cities[t];if(void 0!==e.materialData&&!e.loadingMaterialData){var i=this._heatmapLayers;Object.keys(e.materialData).forEach(function(t){if(n.hasOwnProperty(t)){if(!this._bcMaterialOptions[t].checked)return void this._map.removeLayer(i[t]);this._map.addLayer(i[t]);var a=Object.keys(e.materialData[t]).map(function(t){var e=this[t];return{lat:+e[1],lng:+e[0],count:1}},e.materialData[t]);i[t].setData({max:8,data:a})}},this)}}},showCityList:function(){return this._cityListIsShown?!1:(this._cityListIsShown=!0,this.element.classList.add("_state-cityList"),!0)},hideCityList:function(){return this._cityListIsShown?(this._cityListIsShown=!1,this.element.classList.remove("_state-cityList"),!0):!1},toogleCityList:function(t){return void 0===t&&(t=!this._cityListIsShown),t?this.showCityList():this.hideCityList(),t},destroy:function(){this.stopListening()}});window.materialsApp=new r},{"./krion/krion":2}],2:[function(t,e,i){!function(t){function n(){}function a(){return++g}function r(t){return t._uid||(t._uid=++g)}function s(t,e){return Object.keys(e).forEach(function(i){t[i]=e[i]}),t}function o(t,e){return Object.getOwnPropertyNames(e).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}),t}function c(t){return o(Object.create(Object.getPrototypeOf(t)),t)}function l(e,i){1==arguments.length?(i=e,e=Object):e===t&&(e=Object);var n;n=i.hasOwnProperty("constructor")?i.constructor:i.constructor=function r(){var t=this instanceof r?this:Object.create(r.prototype);return t._init&&t._init.apply(t,arguments),t};var a=n.prototype=Object.create("function"==typeof e?e.prototype:e);return i.static&&(o(n,i.static),delete i.static),o(a,i),!a.hasOwnProperty("toString")&&a.hasOwnProperty("__name")&&(a.toString=function(){return"[object "+this.__name+"]"}),n}function u(t,e){if(e)e.forEach(function(e){t[e]=t[e].bind(t)});else{var i,n=t.constructor._listenersForBinding;if(!n){n=t.constructor._listenersForBinding=Object.create(null);for(i in t)k.test(i)&&(n[i]=t[i])}for(i in n)t[i]=t[i].bind(t)}}function d(t,e){return Array.isArray(e)||(e=Array.prototype.slice.call(arguments,1)),t.replace(/%(\d+)/g,function(t,i){return e[Number(i)-1]})}function h(t,e,i){if(i)for(;t=t.parentNode;){if(t==e)return!0;if(t==i)break}else for(;t=t.parentNode;)if(t==e)return!0;return!1}function f(t,e,i){return t==e||h(t,e,i)}function m(t,e,i){return _(document.createElement(t),e,i)}function p(t,e){var i=document.createElement("div");return arguments.length>1&&(Array.isArray(e)||(e=Array.prototype.slice.call(arguments,1)),t=d(t,e)),i.innerHTML=t,1==i.childNodes.length&&1==i.firstChild.nodeType?i.firstChild:i}function _(t,e,i){if(null!=e&&Object.keys(e).forEach(function(i){t.setAttribute(i,e[i])}),null!=i)if(Array.isArray(i))i.forEach(function(e){t.appendChild("string"==typeof e?document.createTextNode(e):e)});else switch(i.nodeType){case 1:y(i,t);break;case 11:t.appendChild(i)}return t}function y(t,e){if(t!=e)for(;t.firstChild;)e.appendChild(t.firstChild);return e}function b(t){return t.parentNode&&t.parentNode.removeChild(t),t}function v(t,e){var i=document.createElement("script");i.src=t,i.async=!0,i.onload=i.onerror=function(t){i.onload=i.onerror=null,setTimeout(function(){e("load"==t.type)},1)},(document.head||document.documentElement).appendChild(i)}function C(e,i,n){function r(){clearTimeout(o),delete window[n.callbackName],s.onerror=null,s.parentNode.removeChild(s)}null==n&&(n={}),n.callbackKey||(n.callbackKey="callback"),n.callbackName||(n.callbackName="__callback"+a()),n.preventCaching===t&&(n.preventCaching=!0),n.cachingPreventionKey||(n.cachingPreventionKey="_r"),n.timeout||(n.timeout=3e4);var s=document.createElement("script");s.src=e+(-1!=e.indexOf("?")?"&":"?")+n.callbackKey+"="+n.callbackName+(n.preventCaching?"&"+n.cachingPreventionKey+"="+Math.random():""),s.async=!0,s.onerror=function(){r(),n.onFailure&&n.onFailure.call(window)},window[n.callbackName]=function(){r(),i.apply(this,arguments)};var o=setTimeout(function(){r(),n.onFailure&&n.onFailure.call(window)},n.timeout);(document.head||document.documentElement).appendChild(s)}function L(t){t.target.removeEventListener?t.target.removeEventListener(t.type,t.context?t.wrapper:t.listener):t.target.off(t.type,t.listener,t.context)}var g=0;n.nextUID=a,n.object={},n.object.getUID=r,n.object.assign=s,n.object.mixin=o,n.object.clone=c,n.createClass=l;var k=/^_on[A-Z]/;n.bindListeners=u,n.regex={},n.regex.escape=escape,n.tmpl={},n.tmpl.format=d,n.dom={},n.dom.isDescendantOf=h,n.dom.isSelfOrDescendantOf=f,n.dom.createElement=m,n.dom.createElementFromHTML=p,n.dom.setElement=_,n.dom.moveChildren=y,n.dom.removeNode=b,n.dom.addScript=v,n.ajax={},n.ajax.jsonp=C;n.Emitter=l({__name:"krion.Emitter",_events:null,_listeningTo:null,on:function(t,e,i){var n=this._events||(this._events=Object.create(null));return(n[t]||(n[t]=[])).push({listener:e,context:i}),this},off:function(e,i,n){var a=this._events;if(!a)return this;if(e===t){for(var r=Object.keys(a),s=r.length;s;)this.off(r[--s],i,n);return this}if(a=a[e]){for(var s=a.length;s;){var o=a[--s];i!==t&&i!=o.listener&&i!=o.listener._inner||n!=o.context||a.splice(s,1)}a.length||delete this._events[e]}return this},once:function(t,e,i){function n(){this.off(t,n),e.apply(this,arguments)}return n._inner=e,this.on(t,n,i)},emit:function(t){var e=(this._events||(this._events=Object.create(null)))[t];if(e)for(var i=Array.prototype.slice.call(arguments,1),n=0,a=e.length;a>n;n++)e[n].listener.apply(e[n].context||this,i);return this},listenTo:function(t,e,i,n){var a=this._listeningTo||(this._listeningTo=Object.create(null)),s=r(t)+"-"+e+"-"+r(i)+(n?r(n):"0");if(!(s in a))if(a[s]={target:t,type:e,listener:i,context:n},t.addEventListener)if(n){var o=a[s].wrapper=i.bind(n);o._inner=i,t.addEventListener(e,o)}else t.addEventListener(e,i);else t.on(e,i,n);return this},stopListening:function(t,e,i,n){var a=this._listeningTo||(this._listeningTo=Object.create(null));if(arguments.length){var s=r(t)+"-"+e+"-"+r(i)+(n?r(n):"0");s in a&&(L(a[s]),delete a[s])}else for(var s in a)L(a[s]),delete a[s];return this}});"undefined"!=typeof i?"undefined"!=typeof e&&e.exports?e.exports=n:i.krion=n:window.krion=n}()},{}]},{},[1]);